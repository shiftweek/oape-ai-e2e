apiVersion: v1
kind: ConfigMap
metadata:
  name: oape-server-config
data:
  CLAUDE_CODE_USE_VERTEX: "1"
  CLOUD_ML_REGION: "us-east5"
  ANTHROPIC_VERTEX_PROJECT_ID: "[gcp-project-id]"
  ANTHROPIC_MODEL: "claude-3-5-sonnet-v2@20241022"
---
apiVersion: v1
kind: Secret
metadata:
  name: gcloud-adc-secret
type: Opaque
stringData:
  # Replace with ~/.config/gcloud/application_default_credentials.json
  # that can authenticate with GCP project.
  application_default_credentials.json: '{}'
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oape-server
  labels:
    app: oape-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oape-server
  template:
    metadata:
      labels:
        app: oape-server
    spec:
      containers:
        - name: oape-server
          image: ghcr.io/shiftweek/oape-ai-e2e:latest
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: oape-server-config
          env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /secrets/gcloud/application_default_credentials.json
          volumeMounts:
            - name: gcloud-adc
              mountPath: /secrets/gcloud
              readOnly: true
      volumes:
        - name: gcloud-adc
          secret:
            secretName: gcloud-adc-secret
---
apiVersion: v1
kind: Service
metadata:
  name: oape-server
spec:
  selector:
    app: oape-server
  ports:
    - port: 8000
      targetPort: 8000
  type: ClusterIP
