<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OAPE Operator Feature Developer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5;
         display: flex; justify-content: center; padding: 40px 16px; }
  .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.1);
          padding: 32px; max-width: 720px; width: 100%; }
  h1 { font-size: 1.4rem; margin-bottom: 4px; }
  p.sub { color: #666; font-size: .9rem; margin-bottom: 24px; }
  label { display: block; font-weight: 600; margin-bottom: 6px; font-size: .9rem; }
  input[type=text], select { width: 100%; padding: 10px 12px; border: 1px solid #ccc;
                   border-radius: 6px; font-size: .95rem; }
  input[type=text]:focus, select:focus { outline: none; border-color: #4a90d9; }
  button { margin-top: 16px; padding: 10px 24px; background: #4a90d9; color: #fff;
           border: none; border-radius: 6px; font-size: .95rem; cursor: pointer; }
  button:disabled { background: #aaa; cursor: not-allowed; }
  .spinner { display: inline-block; width: 18px; height: 18px;
             border: 3px solid #ccc; border-top-color: #4a90d9;
             border-radius: 50%; animation: spin .8s linear infinite;
             vertical-align: middle; margin-right: 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #status { margin-top: 20px; font-size: .9rem; color: #555; }
  #conversation { margin-top: 16px; background: #fafafa; border: 1px solid #e0e0e0;
                  border-radius: 6px; max-height: 500px; overflow-y: auto;
                  display: none; }
  #conversation .msg { padding: 10px 14px; border-bottom: 1px solid #eee;
                       font-size: .85rem; line-height: 1.5; }
  #conversation .msg:last-child { border-bottom: none; }
  .msg-text { color: #333; }
  .msg-text .label { font-weight: 600; color: #4a90d9; margin-right: 6px; }
  .msg-tool { color: #8B6914; background: #FFF8E7; font-family: monospace; font-size: .82rem; }
  .msg-tool-result { color: #555; background: #f5f5f5; font-family: monospace;
                     font-size: .82rem; white-space: pre-wrap; word-break: break-word; }
  .msg-thinking { color: #7B1FA2; background: #F3E5F5; font-style: italic; }
  .msg-result { color: #2E7D32; background: #E8F5E9; font-weight: 600; }
  .msg-other { color: #888; font-size: .8rem; }
  #output { margin-top: 16px; background: #1e1e1e; color: #d4d4d4;
            padding: 16px; border-radius: 6px; font-family: monospace;
            font-size: .85rem; white-space: pre-wrap; word-break: break-word;
            max-height: 500px; overflow-y: auto; display: none; }
  .error { color: #c0392b; }
  .content-preview { max-height: 120px; overflow: hidden; position: relative; }
  .content-preview.expanded { max-height: none; }
  .toggle-expand { color: #4a90d9; cursor: pointer; font-size: .8rem;
                   display: inline-block; margin-top: 4px; }
</style>
</head>
<body>
<div class="card">
  <h1>OAPE Operator Feature Developer</h1>
  <p class="sub">Generate controller code from an OpenShift Enhancement Proposal</p>
  <form id="epForm">
    <label for="command">Command</label>
    <select id="command" name="command">
      <option value="api-implement" selected>api-implement</option>
      <option value="analyze-rfe">analyze-rfe</option>
    </select>
    <label for="ep_url" id="ep_url_label" style="margin-top:14px">Enhancement Proposal PR URL</label>
    <input type="text" id="ep_url" name="ep_url"
           placeholder="https://github.com/openshift/enhancements/pull/1234" required>
    <label for="cwd" style="margin-top:14px">Working Directory <span style="color:#999">(optional)</span></label>
    <input type="text" id="cwd" name="cwd" placeholder="/path/to/operator-repo">
    <button type="submit" id="submitBtn">Generate</button>
  </form>
  <div id="status"></div>
  <div id="conversation"></div>
  <pre id="output"></pre>
</div>
<script>
const form     = document.getElementById('epForm');
const btn      = document.getElementById('submitBtn');
const statusEl = document.getElementById('status');
const convEl   = document.getElementById('conversation');
const outputEl = document.getElementById('output');
const epUrlLabel = document.getElementById('ep_url_label');
const epUrlInput = document.getElementById('ep_url');

function updateInputLabel() {
  const command = document.getElementById('command').value;
  if (command === 'analyze-rfe') {
    epUrlLabel.textContent = 'RFE key or Jira URL';
    epUrlInput.placeholder = 'RFE-7841 or https://issues.redhat.com/browse/RFE-7841';
  } else {
    epUrlLabel.textContent = 'Enhancement Proposal PR URL';
    epUrlInput.placeholder = 'https://github.com/openshift/enhancements/pull/1234';
  }
}
document.getElementById('command').addEventListener('change', updateInputLabel);

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

function truncate(str, maxLen) {
  if (!str) return '';
  return str.length <= maxLen ? str : str.substring(0, maxLen) + '\u2026';
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const epUrl   = document.getElementById('ep_url').value.trim();
  const cwd     = document.getElementById('cwd').value.trim();
  const command = document.getElementById('command').value;
  if (!epUrl) return;

  btn.disabled = true;
  outputEl.style.display = 'none';
  outputEl.textContent = '';
  convEl.style.display = 'none';
  convEl.innerHTML = '';
  statusEl.innerHTML = '<span class="spinner"></span> Submitting job\u2026';

  try {
    const body = new URLSearchParams({ep_url: epUrl, command: command});
    if (cwd) body.append('cwd', cwd);
    const res = await fetch('/submit', {method: 'POST', body});
    if (!res.ok) { throw new Error((await res.json()).detail || res.statusText); }
    const {job_id} = await res.json();
    statusEl.innerHTML = '<span class="spinner"></span> Connecting to agent stream\u2026';
    streamJob(job_id);
  } catch (err) {
    statusEl.innerHTML = '<span class="error">Error: ' + escapeHtml(err.message) + '</span>';
    btn.disabled = false;
  }
});

function streamJob(jobId) {
  const es = new EventSource('/stream/' + jobId);

  es.addEventListener('message', (e) => {
    const msg = JSON.parse(e.data);
    convEl.style.display = 'block';
    appendMessage(msg);
    updateStatus(msg);
  });

  es.addEventListener('complete', (e) => {
    const result = JSON.parse(e.data);
    es.close();
    btn.disabled = false;

    if (result.status === 'success') {
      statusEl.innerHTML = 'Done! Cost: $' + (result.cost_usd || 0).toFixed(4);
      if (result.output) {
        outputEl.textContent = result.output;
        outputEl.style.display = 'block';
      }
    } else {
      statusEl.innerHTML = '<span class="error">Failed: '
        + escapeHtml(result.error || 'unknown error') + '</span>';
    }
  });

  es.addEventListener('error', () => {
    es.close();
    btn.disabled = false;
    if (statusEl.querySelector('.spinner')) {
      statusEl.innerHTML = '<span class="error">Stream connection lost</span>';
    }
  });
}

function appendMessage(msg) {
  const div = document.createElement('div');
  div.className = 'msg';

  if (msg.type === 'assistant' && msg.block_type === 'text') {
    div.classList.add('msg-text');
    div.innerHTML = '<span class="label">Assistant</span>'
      + escapeHtml(msg.content);
  } else if (msg.type === 'assistant' && msg.block_type === 'tool_use') {
    div.classList.add('msg-tool');
    const inputPreview = truncate(JSON.stringify(msg.tool_input), 200);
    div.innerHTML = '&#9881; <b>' + escapeHtml(msg.tool_name) + '</b> '
      + '<span style="color:#aaa">' + escapeHtml(inputPreview) + '</span>';
  } else if (msg.type === 'assistant' && msg.block_type === 'tool_result') {
    div.classList.add('msg-tool-result');
    const content = typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content);
    const preview = truncate(content, 500);
    const prefix = msg.is_error ? '&#10060; ' : '&#10004; ';
    div.innerHTML = prefix + escapeHtml(preview);
  } else if (msg.type === 'assistant' && msg.block_type === 'thinking') {
    div.classList.add('msg-thinking');
    div.textContent = 'Thinking\u2026';
  } else if (msg.type === 'result') {
    div.classList.add('msg-result');
    div.textContent = 'Result received (cost: $'
      + (msg.cost_usd || 0).toFixed(4) + ')';
  } else {
    div.classList.add('msg-other');
    div.textContent = '[' + (msg.type || 'event') + '] '
      + truncate(msg.content || '', 100);
  }

  convEl.appendChild(div);
  convEl.scrollTop = convEl.scrollHeight;
}

function updateStatus(msg) {
  if (msg.type === 'assistant' && msg.block_type === 'text') {
    statusEl.innerHTML = '<span class="spinner"></span> '
      + escapeHtml(truncate(msg.content, 80));
  } else if (msg.type === 'assistant' && msg.block_type === 'tool_use') {
    statusEl.innerHTML = '<span class="spinner"></span> Running: '
      + escapeHtml(msg.tool_name) + '\u2026';
  } else if (msg.type === 'assistant' && msg.block_type === 'thinking') {
    statusEl.innerHTML = '<span class="spinner"></span> Agent is thinking\u2026';
  } else if (msg.type === 'result') {
    statusEl.innerHTML = '<span class="spinner"></span> Finalizing\u2026';
  }
}
</script>
</body>
</html>
